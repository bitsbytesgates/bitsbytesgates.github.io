---
layout: post
title: Selectively Muting your BFMs to Speed up Simulation
date: '2020-02-08T16:36:00.001-08:00'
author: Matthew Ballance
tags:
- Icarus Verilog
- Python
- Verilator
- BFMs
- Bus Functional Models
- Cocotb
modified_time: '2020-02-08T16:36:20.648-08:00'
thumbnail: https://1.bp.blogspot.com/-UoX-MENpuM8/Xj76LKiikGI/AAAAAAAAC14/xrUv2Kl-P1UxpUtfzoRj-AmcKItNaTOGgCLcBGAsYHQ/s72-c/splash.png
blogger_id: tag:blogger.com,1999:blog-142675602739945566.post-3730890952553056874
blogger_orig_url: https://bitsbytesgates.blogspot.com/2020/02/selectively-muting-your-bfms-to-speed.html
---

<br /><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-UoX-MENpuM8/Xj76LKiikGI/AAAAAAAAC14/xrUv2Kl-P1UxpUtfzoRj-AmcKItNaTOGgCLcBGAsYHQ/s1600/splash.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="300" data-original-width="540" src="https://1.bp.blogspot.com/-UoX-MENpuM8/Xj76LKiikGI/AAAAAAAAC14/xrUv2Kl-P1UxpUtfzoRj-AmcKItNaTOGgCLcBGAsYHQ/s1600/splash.png" /></a></div><br />Have you ever had the misfortune to be on the CC list for a "lively" email discussion where you're a stakeholder but only case about the conclusion? You can't simply ignore the traffic, because you do care about the conclusion to the discussion. But, it would be a significant time saver if you could just "tune out" all the discussion and simply be notified when a conclusion is reached.<br /><br />I've been working with Python-based testbench environments (specifically <a href="https://cocotb.readthedocs.io/en/latest/introduction.html">cocotb</a>) since the middle of last year. My first foray into contributing to cocotb was to implement a task-based BFM interface between the HDL environment and the Python environment (related blog posts <a href="https://bitsbytesgates.blogspot.com/2019/11/adding-task-based-bus-functional-models.html">here</a> and <a href="https://bitsbytesgates.blogspot.com/2019/12/writing-task-based-cocotb-bfm.html">here</a>). The motivation was to increase simulation speed by reducing the number of interactions between the HDL environment and the testbench environment. In other words, allow the Python testbench to "tune out" what was happening in the simulation until the BFM came back with some useful conclusions.<br /><br />The performance benefits of abstracting up and interacting at the task-call level come from maximizing the amount of time the simulation engine can run before it needs to check in with the testbench environment. Getting good performance also requires having the HDL environment generate clocks for the design, in addition to having Python interact with BFMs at the task level to drive stimulus against the design.<br /><br />The performance benefits of this approach do vary a bit. If all of your tests interact with the design at the signal level and still only run for a small number of seconds each, then changing the way you interact with the simulation is unlikely to improve performance. A significant percentage of the time in your simulation runs is likely taken up by environment startup, and you might not really care about the run time anyway (what's a few extra seconds, right?)<br /><br />For tests that run longer, though, the performance benefits can be quite significant. One of my projects is Featherweight RISC (<a href="https://github.com/mballance/fwrisc">FWRISC</a>), a small RISC-V implementation. One of the <a href="https://www.zephyrproject.org/">Zephyr-OS</a> tests that runs as part of the regression suite tests the ability to synchronize between multiple threads. Unlike the simple unit tests or compliance tests, this test runs for quite a while. Here, we see a pretty significant difference in runtime based on whether we interact with the simulation via signals or BFM tasks.<br /><br /><table border="1" class="Table Border SCXO98129096 BCX0" style="-webkit-tap-highlight-color: transparent; -webkit-user-drag: none; background-color: white; border-collapse: collapse; color: black; empty-cells: show; font-family: &quot;Segoe UI&quot;, &quot;Segoe UI Web&quot;, Arial, Verdana, sans-serif; font-size: 12px; margin: 0px; min-width: 0px; overflow: visible; padding: 0px; position: relative; user-select: text;"><tbody class="SCXO98129096 BCX0" style="-webkit-tap-highlight-color: transparent; -webkit-user-drag: none; margin: 0px; padding: 0px; user-select: text;"><tr class="TableRow SCXO98129096 BCX0" role="row" style="-webkit-tap-highlight-color: transparent; -webkit-user-drag: none; height: auto; margin: 0px; overflow: visible; padding: 0px; user-select: text;"><td class="SCXO98129096 BCX0" role="rowheader" style="-webkit-tap-highlight-color: transparent; -webkit-user-drag: none; background-color: transparent; border: 1px solid rgb(200, 202, 204); margin: 0px; overflow: visible; padding: 3px 0px; user-select: text; vertical-align: top; word-break: break-word;"><div class="TableCellContent SCXO98129096 BCX0" style="-webkit-tap-highlight-color: transparent; -webkit-user-drag: none; margin: 0px; padding: 0px 4px; user-select: text;"><div class="OutlineElement Ltr SCXO98129096 BCX0" style="-webkit-tap-highlight-color: transparent; -webkit-user-drag: none; clear: both; cursor: text; direction: ltr; margin: 0px; overflow: visible; padding: 0px; position: relative; user-select: text;"><div class="Paragraph SCXO98129096 BCX0" lang="EN-US" style="-webkit-tap-highlight-color: transparent; -webkit-user-drag: none; background-color: transparent; color: windowtext; overflow-wrap: break-word; padding: 0px; user-select: text; vertical-align: baseline;" xml:lang="EN-US"><span class="TextRun SCXO98129096 BCX0" data-contrast="auto" lang="EN-US" style="font-family: &quot;calibri&quot; , &quot;calibri_msfontservice&quot; , sans-serif; font-size: 11pt; line-height: 18px; margin: 0px; padding: 0px;" xml:lang="EN-US">Scenario</span><span class="EOP SCXO98129096 BCX0" style="font-family: &quot;calibri&quot; , &quot;calibri_msfontservice&quot; , sans-serif; font-size: 11pt; line-height: 18px; margin: 0px; padding: 0px;">&nbsp;</span></div></div></div></td><td class="SCXO98129096 BCX0" role="columnheader" style="-webkit-tap-highlight-color: transparent; -webkit-user-drag: none; background-color: transparent; border: 1px solid rgb(200, 202, 204); margin: 0px; overflow: visible; padding: 3px 0px; user-select: text; vertical-align: top; word-break: break-word;"><div class="TableCellContent SCXO98129096 BCX0" style="-webkit-tap-highlight-color: transparent; -webkit-user-drag: none; margin: 0px; padding: 0px 4px; user-select: text;"><div class="OutlineElement Ltr SCXO98129096 BCX0" style="-webkit-tap-highlight-color: transparent; -webkit-user-drag: none; clear: both; cursor: text; direction: ltr; margin: 0px; overflow: visible; padding: 0px; position: relative; user-select: text;"><div class="Paragraph SCXO98129096 BCX0" lang="EN-US" style="-webkit-tap-highlight-color: transparent; -webkit-user-drag: none; background-color: transparent; color: windowtext; overflow-wrap: break-word; padding: 0px; user-select: text; vertical-align: baseline;" xml:lang="EN-US"><span class="TextRun SCXO98129096 BCX0" data-contrast="auto" lang="EN-US" style="font-family: &quot;calibri&quot; , &quot;calibri_msfontservice&quot; , sans-serif; font-size: 11pt; line-height: 18px; margin: 0px; padding: 0px;" xml:lang="EN-US">Time</span><span class="EOP SCXO98129096 BCX0" style="font-family: &quot;calibri&quot; , &quot;calibri_msfontservice&quot; , sans-serif; font-size: 11pt; line-height: 18px; margin: 0px; padding: 0px;">&nbsp;</span></div></div></div></td></tr><tr class="TableRow SCXO98129096 BCX0" role="row" style="-webkit-tap-highlight-color: transparent; -webkit-user-drag: none; height: auto; margin: 0px; overflow: visible; padding: 0px; user-select: text;"><td class="SCXO98129096 BCX0" role="rowheader" style="-webkit-tap-highlight-color: transparent; -webkit-user-drag: none; background-color: transparent; border: 1px solid rgb(200, 202, 204); margin: 0px; overflow: visible; padding: 3px 0px; user-select: text; vertical-align: top; word-break: break-word;"><div class="TableCellContent SCXO98129096 BCX0" style="-webkit-tap-highlight-color: transparent; -webkit-user-drag: none; margin: 0px; padding: 0px 4px; user-select: text;"><div class="OutlineElement Ltr SCXO98129096 BCX0" style="-webkit-tap-highlight-color: transparent; -webkit-user-drag: none; clear: both; cursor: text; direction: ltr; margin: 0px; overflow: visible; padding: 0px; position: relative; user-select: text;"><div class="Paragraph SCXO98129096 BCX0" lang="EN-US" style="-webkit-tap-highlight-color: transparent; -webkit-user-drag: none; background-color: transparent; color: windowtext; overflow-wrap: break-word; padding: 0px; user-select: text; vertical-align: baseline;" xml:lang="EN-US"><span class="TextRun SCXO98129096 BCX0" data-contrast="auto" lang="EN-US" style="font-family: &quot;calibri&quot; , &quot;calibri_msfontservice&quot; , sans-serif; font-size: 11pt; line-height: 18px; margin: 0px; padding: 0px;" xml:lang="EN-US">Icarus / Signal BFM</span><span class="EOP SCXO98129096 BCX0" style="font-family: &quot;calibri&quot; , &quot;calibri_msfontservice&quot; , sans-serif; font-size: 11pt; line-height: 18px; margin: 0px; padding: 0px;">&nbsp;</span></div></div></div></td><td class="SCXO98129096 BCX0" style="-webkit-tap-highlight-color: transparent; -webkit-user-drag: none; background-color: transparent; border: 1px solid rgb(200, 202, 204); margin: 0px; overflow: visible; padding: 3px 0px; user-select: text; vertical-align: top; word-break: break-word;"><div class="TableCellContent SCXO98129096 BCX0" style="-webkit-tap-highlight-color: transparent; -webkit-user-drag: none; margin: 0px; padding: 0px 4px; user-select: text;"><div class="OutlineElement Ltr SCXO98129096 BCX0" style="-webkit-tap-highlight-color: transparent; -webkit-user-drag: none; clear: both; cursor: text; direction: ltr; margin: 0px; overflow: visible; padding: 0px; position: relative; user-select: text;"><div class="Paragraph SCXO98129096 BCX0" lang="EN-US" style="-webkit-tap-highlight-color: transparent; -webkit-user-drag: none; background-color: transparent; color: windowtext; overflow-wrap: break-word; padding: 0px; user-select: text; vertical-align: baseline;" xml:lang="EN-US"><span class="TextRun SCXO98129096 BCX0" data-contrast="auto" lang="EN-US" style="font-family: &quot;calibri&quot; , &quot;calibri_msfontservice&quot; , sans-serif; font-size: 11pt; line-height: 18px; margin: 0px; padding: 0px;" xml:lang="EN-US">17:06</span><span class="EOP SCXO98129096 BCX0" style="font-family: &quot;calibri&quot; , &quot;calibri_msfontservice&quot; , sans-serif; font-size: 11pt; line-height: 18px; margin: 0px; padding: 0px;">&nbsp;</span></div></div></div></td></tr><tr class="TableRow SCXO98129096 BCX0" role="row" style="-webkit-tap-highlight-color: transparent; -webkit-user-drag: none; height: auto; margin: 0px; overflow: visible; padding: 0px; user-select: text;"><td class="SCXO98129096 BCX0" role="rowheader" style="-webkit-tap-highlight-color: transparent; -webkit-user-drag: none; background-color: transparent; border: 1px solid rgb(200, 202, 204); margin: 0px; overflow: visible; padding: 3px 0px; user-select: text; vertical-align: top; word-break: break-word;"><div class="TableCellContent SCXO98129096 BCX0" style="-webkit-tap-highlight-color: transparent; -webkit-user-drag: none; margin: 0px; padding: 0px 4px; user-select: text;"><div class="OutlineElement Ltr SCXO98129096 BCX0" style="-webkit-tap-highlight-color: transparent; -webkit-user-drag: none; clear: both; cursor: text; direction: ltr; margin: 0px; overflow: visible; padding: 0px; position: relative; user-select: text;"><div class="Paragraph SCXO98129096 BCX0" lang="EN-US" style="-webkit-tap-highlight-color: transparent; -webkit-user-drag: none; background-color: transparent; color: windowtext; overflow-wrap: break-word; padding: 0px; user-select: text; vertical-align: baseline;" xml:lang="EN-US"><span class="TextRun SCXO98129096 BCX0" data-contrast="auto" lang="EN-US" style="font-family: &quot;calibri&quot; , &quot;calibri_msfontservice&quot; , sans-serif; font-size: 11pt; line-height: 18px; margin: 0px; padding: 0px;" xml:lang="EN-US">Icarus / Task BFM</span><span class="EOP SCXO98129096 BCX0" style="font-family: &quot;calibri&quot; , &quot;calibri_msfontservice&quot; , sans-serif; font-size: 11pt; line-height: 18px; margin: 0px; padding: 0px;">&nbsp;</span></div></div></div></td><td class="SCXO98129096 BCX0" style="-webkit-tap-highlight-color: transparent; -webkit-user-drag: none; background-color: transparent; border: 1px solid rgb(200, 202, 204); margin: 0px; overflow: visible; padding: 3px 0px; user-select: text; vertical-align: top; word-break: break-word;"><div class="TableCellContent SCXO98129096 BCX0" style="-webkit-tap-highlight-color: transparent; -webkit-user-drag: none; margin: 0px; padding: 0px 4px; user-select: text;"><div class="OutlineElement Ltr SCXO98129096 BCX0" style="-webkit-tap-highlight-color: transparent; -webkit-user-drag: none; clear: both; cursor: text; direction: ltr; margin: 0px; overflow: visible; padding: 0px; position: relative; user-select: text;"><div class="Paragraph SCXO98129096 BCX0" lang="EN-US" style="-webkit-tap-highlight-color: transparent; -webkit-user-drag: none; background-color: transparent; color: windowtext; overflow-wrap: break-word; padding: 0px; user-select: text; vertical-align: baseline;" xml:lang="EN-US"><span class="TextRun SCXO98129096 BCX0" data-contrast="auto" lang="EN-US" style="font-family: &quot;calibri&quot; , &quot;calibri_msfontservice&quot; , sans-serif; font-size: 11pt; line-height: 18px; margin: 0px; padding: 0px;" xml:lang="EN-US">1:51</span><span class="EOP SCXO98129096 BCX0" style="font-family: &quot;calibri&quot; , &quot;calibri_msfontservice&quot; , sans-serif; font-size: 11pt; line-height: 18px; margin: 0px; padding: 0px;">&nbsp;</span></div></div></div></td></tr><tr class="TableRow SCXO98129096 BCX0" role="row" style="-webkit-tap-highlight-color: transparent; -webkit-user-drag: none; height: auto; margin: 0px; overflow: visible; padding: 0px; user-select: text;"><td class="SCXO98129096 BCX0" role="rowheader" style="-webkit-tap-highlight-color: transparent; -webkit-user-drag: none; background-color: transparent; border: 1px solid rgb(200, 202, 204); margin: 0px; overflow: visible; padding: 3px 0px; user-select: text; vertical-align: top; word-break: break-word;"><div class="TableCellContent SCXO98129096 BCX0" style="-webkit-tap-highlight-color: transparent; -webkit-user-drag: none; margin: 0px; padding: 0px 4px; user-select: text;"><div class="OutlineElement Ltr  BCX0 SCXO98129096" style="-webkit-tap-highlight-color: transparent; -webkit-user-drag: none; clear: both; cursor: text; direction: ltr; margin: 0px; overflow: visible; padding: 0px; position: relative; user-select: text;"><div class="Paragraph SCXO98129096 BCX0" lang="EN-US" style="-webkit-tap-highlight-color: transparent; -webkit-user-drag: none; background-color: transparent; color: windowtext; overflow-wrap: break-word; padding: 0px; user-select: text; vertical-align: baseline;" xml:lang="EN-US"><span class="TextRun SCXO98129096 BCX0" data-contrast="auto" lang="EN-US" style="font-family: &quot;calibri&quot; , &quot;calibri_msfontservice&quot; , sans-serif; font-size: 11pt; line-height: 18px; margin: 0px; padding: 0px;" xml:lang="EN-US"><span class="SpellingError SCXO98129096 BCX0" style="-webkit-tap-highlight-color: transparent; -webkit-user-drag: none; background-color: inherit; background-image: url(&quot;data:image/gif; background-position: left bottom; background-repeat: repeat-x; border-bottom: 1px solid transparent; margin: 0px; padding: 0px; user-select: text;">Verilator</span><span class="NormalTextRun SCXO98129096 BCX0" style="-webkit-tap-highlight-color: transparent; -webkit-user-drag: none; background-color: inherit; margin: 0px; padding: 0px; user-select: text;">&nbsp;/ Task BFM</span></span><span class="EOP SCXO98129096 BCX0" style="font-family: &quot;calibri&quot; , &quot;calibri_msfontservice&quot; , sans-serif; font-size: 11pt; line-height: 18px; margin: 0px; padding: 0px;">&nbsp;</span></div></div></div></td><td class="SCXO98129096 BCX0" style="-webkit-tap-highlight-color: transparent; -webkit-user-drag: none; background-color: transparent; border: 1px solid rgb(200, 202, 204); margin: 0px; overflow: visible; padding: 3px 0px; user-select: text; vertical-align: top; word-break: break-word;"><div class="TableCellContent SCXO98129096 BCX0" style="-webkit-tap-highlight-color: transparent; -webkit-user-drag: none; margin: 0px; padding: 0px 4px; user-select: text;"><div class="OutlineElement Ltr SCXO98129096 BCX0" style="-webkit-tap-highlight-color: transparent; -webkit-user-drag: none; clear: both; cursor: text; direction: ltr; margin: 0px; overflow: visible; padding: 0px; position: relative; user-select: text;"><div class="Paragraph SCXO98129096 BCX0" lang="EN-US" style="-webkit-tap-highlight-color: transparent; -webkit-user-drag: none; background-color: transparent; color: windowtext; overflow-wrap: break-word; padding: 0px; user-select: text; vertical-align: baseline;" xml:lang="EN-US"><span class="TextRun SCXO98129096 BCX0" data-contrast="auto" lang="EN-US" style="font-family: &quot;calibri&quot; , &quot;calibri_msfontservice&quot; , sans-serif; font-size: 11pt; line-height: 18px; margin: 0px; padding: 0px;" xml:lang="EN-US">0:06</span><span class="EOP SCXO98129096 BCX0" style="font-family: &quot;calibri&quot; , &quot;calibri_msfontservice&quot; , sans-serif; font-size: 11pt; line-height: 18px; margin: 0px; padding: 0px;">&nbsp;</span></div></div></div></td></tr></tbody></table><br />The table above compares running the same test in <a href="http://iverilog.icarus.com/">Icarus Verilog</a> using signal-level interaction and in Icarus Verilog using task-based interaction. Simply switching to task-based interaction reduces the runtime by a factor of 9.2x! Moving from interpreted event-driven simulation to Verilator's two-state cycle-based simulation engine allows us even more speed.<br /><br /><b>Delegating Decisions to the BFM</b><br /><br />This type of performance speed-up is quite nice, especially since the BFMs are quite simple. But, can we do better? In short, the answer is yes. We just need to continue down the path of reducing the number of interactions between simulation and testbench environment.<br /><br />With task-based BFMs, quite a few decisions are already handled locally. For example, a UART BFM will typically handle the details of transmitting/receiving a byte, allowing the testbench to only interact with the BFM at byte boundaries.<br /><br />There are cases, however, where a bit more flexibility is required. For example, an <a href="https://en.wikipedia.org/wiki/Advanced_eXtensible_Interface">AMBA AXI</a>&nbsp;BFM may handle all details of burst and phase timing under normal circumstances. Sometimes, however, the testbench might need to take fine-grained control for testing corner cases. Always interacting at the detail level will hurt performance of the common case. The solution is to have multiple (two in this case) operating modes for the BFM that allow us to have the highest performance for the common case, and fine-grained control (with lower performance) in the cases where this is needed.<br /><div><br /></div><div><b>Selective Muting Example: FWRISC Tracer</b>&nbsp;</div><div><br /></div><div><a href="https://github.com/mballance/fwrisc">Featherweight RISC</a> has an execution-trace monitor built it. This is used by most of the regression-suite tests for checking. I've also found it quite helpful in debugging issues above the signal level. For example, when doing initial Zephyr OS bring-up, it was really helpful to be able trace function entry/exit in the log.</div><div><br /></div><div>The FWRISC monitor issues three types of events:</div><ul><li>Instruction executed</li><li>Register write</li><li>Memory write</li></ul><div>Unit tests use all of these events to verify proper operation of the FWRISC core. However, as we move to running higher-level software, many of these events aren't needed.&nbsp;For example, when running Zephyr tests, we're running a not-insignificant amount of software. We definitely don't care to know about every register write. We would only care when debugging the most-obscure of issues! Zephyr can be configured with a buffer-based console, so we do care about some memory writes. However, not the majority. In most cases, we can tell if a test passed from the console output. If, however, we're debugging a test under Zephyr, we might care about function calls. But, we don't need to know about every executed instruction.</div><div><br /></div><div><b><i>Muting Register Writes</i></b></div><div><br /></div><div>The simplest event to disable turns out to be register writes. This is because our level of choice is binary: we only need to enable or disable tracing on register writes.</div><div><br /></div><div><pre style="background-color: #f8f8f8; line-height: 16.25px;"><span class="nd" style="color: #aa22ff;">@cocotb</span><span class="o" style="color: #666666;">.</span><span class="n">bfm</span><span class="p">(</span><span class="n">hdl</span><span class="o" style="color: #666666;">=</span><span class="p">{</span><br />    <span class="n">bfm_vlog</span> <span class="p">:</span> <span class="n">bfm_hdl_path</span><span class="p">(</span><span class="vm" style="color: #19177c;">__file__</span><span class="p">,</span> <span class="s2" style="color: #ba2121;">"hdl/fwrisc_tracer_bfm.v"</span><span class="p">),</span><br />    <span class="n">bfm_sv</span> <span class="p">:</span> <span class="n">bfm_hdl_path</span><span class="p">(</span><span class="vm" style="color: #19177c;">__file__</span><span class="p">,</span> <span class="s2" style="color: #ba2121;">"hdl/fwrisc_tracer_bfm.v"</span><span class="p">)</span><br />    <span class="p">})</span><br /><span class="k" style="color: green; font-weight: bold;">class</span> <span class="nc" style="color: blue; font-weight: bold;">FwriscTracerBfm</span><span class="p">():</span><br /><br />    <span class="c1" style="color: #408080; font-style: italic;"># ...</span><br /><br />    <span class="nd" style="color: #aa22ff;">@cocotb</span><span class="o" style="color: #666666;">.</span><span class="n">bfm_import</span><span class="p">(</span><span class="n">cocotb</span><span class="o" style="color: #666666;">.</span><span class="n">bfm_uint32_t</span><span class="p">)</span><br />    <span class="k" style="color: green; font-weight: bold;">def</span> <span class="nf" style="color: blue;">set_trace_reg_writes</span><span class="p">(</span><span class="bp" style="color: green;">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span><br />        <span class="k" style="color: green; font-weight: bold;">pass</span></pre></div><div><br /></div><div>The Python side of this control is shown above. Specifically, we declare a Python method in the BFM class that will act as a proxy for a task in the SystemVerilog BFM.&nbsp;</div><div><br /></div><div><pre style="background-color: #f8f8f8; line-height: 16.25px;"><span class="k" style="color: green; font-weight: bold;">module</span> <span class="n">fwrisc_tracer_bfm</span><span class="p">(</span><br />                <span class="k" style="color: green; font-weight: bold;">input</span>                   <span class="n">clock</span><span class="p">,</span><br />                <span class="k" style="color: green; font-weight: bold;">input</span>                   <span class="n">reset</span><span class="p">,</span><br />                <span class="c1" style="color: #408080; font-style: italic;">// ...</span><br />                <span class="p">);</span><br />    <span class="k" style="color: green; font-weight: bold;">reg</span>    <span class="n">trace_reg_writes</span> <span class="o" style="color: #666666;">=</span> <span class="mh" style="color: #666666;">1</span><span class="p">;</span><br /><br />    <span class="k" style="color: green; font-weight: bold;">task</span> <span class="n">set_trace_reg_writes</span><span class="p">(</span><span class="k" style="color: green; font-weight: bold;">reg</span> <span class="n">t</span><span class="p">);</span><br />        <span class="n">trace_reg_writes</span> <span class="o" style="color: #666666;">=</span> <span class="n">t</span><span class="p">;</span><br />    <span class="k" style="color: green; font-weight: bold;">endtask</span><br /><br />    <span class="k" style="color: green; font-weight: bold;">always</span> <span class="p">@(</span><span class="k" style="color: green; font-weight: bold;">posedge</span> <span class="n">clock</span><span class="p">)</span> <span class="k" style="color: green; font-weight: bold;">begin</span><br />        <span class="k" style="color: green; font-weight: bold;">if</span> <span class="p">(</span><span class="n">rd_write</span> <span class="o" style="color: #666666;">&amp;&amp;</span> <span class="n">rd_waddr</span> <span class="o" style="color: #666666;">!=</span> <span class="mh" style="color: #666666;">0</span><span class="p">)</span> <span class="k" style="color: green; font-weight: bold;">begin</span><br />            <span class="k" style="color: green; font-weight: bold;">if</span> <span class="p">(</span><span class="n">trace_reg_writes</span><span class="p">)</span> <span class="k" style="color: green; font-weight: bold;">begin</span><br />                <span class="n">reg_write</span><span class="p">(</span><span class="n">rd_waddr</span><span class="p">,</span> <span class="n">rd_wdata</span><span class="p">);</span><br />            <span class="k" style="color: green; font-weight: bold;">end</span><br />        <span class="k" style="color: green; font-weight: bold;">end</span><br />    <span class="k" style="color: green; font-weight: bold;">end</span><br /><br />    <span class="c1" style="color: #408080; font-style: italic;">// ...</span></pre></div><div><br /></div><div>When the user's code calls the set_trace_reg_writes in the Python code, the correspond SystemVerilog task shown above will be called. This very simple task simply update the value of a flag within the BFM that controls whether register-write events are propagated to the testbench. This flag is checked when the BFM detects a register write, and the testbench is notified only if register writes are currently enabled.</div><div><br /></div><div><b><i>Controlling Instruction Tracing</i></b></div><div>We need a bit more control over how instruction tracing. For unit tests, the testbench wants to be aware of all instructions that are executed. When debugging compliance tests, we want to be aware of all branches. When debugging Zephyr tests, we want to be aware of function calls.</div><div><br /></div><div><pre style="background-color: #f8f8f8; line-height: 16.25px;"><span class="nd" style="color: #aa22ff;">@cocotb</span><span class="o" style="color: #666666;">.</span><span class="n">bfm</span><span class="p">(</span><span class="n">hdl</span><span class="o" style="color: #666666;">=</span><span class="p">{</span><br />    <span class="n">bfm_vlog</span> <span class="p">:</span> <span class="n">bfm_hdl_path</span><span class="p">(</span><span class="vm" style="color: #19177c;">__file__</span><span class="p">,</span> <span class="s2" style="color: #ba2121;">"hdl/fwrisc_tracer_bfm.v"</span><span class="p">),</span><br />    <span class="n">bfm_sv</span> <span class="p">:</span> <span class="n">bfm_hdl_path</span><span class="p">(</span><span class="vm" style="color: #19177c;">__file__</span><span class="p">,</span> <span class="s2" style="color: #ba2121;">"hdl/fwrisc_tracer_bfm.v"</span><span class="p">)</span><br />    <span class="p">})</span><br /><span class="k" style="color: green; font-weight: bold;">class</span> <span class="nc" style="color: blue; font-weight: bold;">FwriscTracerBfm</span><span class="p">():</span><br /><br />    <span class="nd" style="color: #aa22ff;">@cocotb</span><span class="o" style="color: #666666;">.</span><span class="n">bfm_import</span><span class="p">(</span><span class="n">cocotb</span><span class="o" style="color: #666666;">.</span><span class="n">bfm_uint32_t</span><span class="p">,</span> <span class="n">cocotb</span><span class="o" style="color: #666666;">.</span><span class="n">bfm_uint32_t</span><span class="p">,</span> <span class="n">cocotb</span><span class="o" style="color: #666666;">.</span><span class="n">bfm_uint32_t</span><span class="p">)</span><br />    <span class="k" style="color: green; font-weight: bold;">def</span> <span class="nf" style="color: blue;">set_trace_instr</span><span class="p">(</span><span class="bp" style="color: green;">self</span><span class="p">,</span> <span class="n">all_instr</span><span class="p">,</span> <span class="n">jump_instr</span><span class="p">,</span> <span class="n">call_instr</span><span class="p">):</span><br />        <span class="k" style="color: green; font-weight: bold;">pass</span></pre></div><div><br /></div><div>On the Python side, not much difference here. We're simply passing more parameters to the SystemVerilog side that reflect the additional controls we wish to have over being notified when an instruction executes.</div><div><br /></div><div><pre style="background-color: #f8f8f8; line-height: 16.25px;"><span class="k" style="color: green; font-weight: bold;">module</span> <span class="n">fwrisc_tracer_bfm</span><span class="p">(</span><br />    <span class="k" style="color: green; font-weight: bold;">input</span>  <span class="n">clock</span><span class="p">,</span><br />    <span class="k" style="color: green; font-weight: bold;">input</span>  <span class="n">reset</span><span class="p">,</span><br />    <span class="c1" style="color: #408080; font-style: italic;">// ...</span><br />    <span class="p">);</span><br /><br />    <span class="c1" style="color: #408080; font-style: italic;">// ...</span><br /><br />    <span class="k" style="color: green; font-weight: bold;">reg</span> <span class="n">trace_instr_all</span> <span class="o" style="color: #666666;">=</span> <span class="mh" style="color: #666666;">1</span><span class="p">;</span><br />    <span class="k" style="color: green; font-weight: bold;">reg</span> <span class="n">trace_instr_jump</span> <span class="o" style="color: #666666;">=</span> <span class="mh" style="color: #666666;">1</span><span class="p">;</span><br />    <span class="k" style="color: green; font-weight: bold;">reg</span> <span class="n">trace_instr_call</span> <span class="o" style="color: #666666;">=</span> <span class="mh" style="color: #666666;">1</span><span class="p">;</span><br /><br />    <span class="k" style="color: green; font-weight: bold;">task</span> <span class="n">set_trace_instr</span><span class="p">(</span><span class="k" style="color: green; font-weight: bold;">reg</span> <span class="n">all</span><span class="p">,</span> <span class="k" style="color: green; font-weight: bold;">reg</span> <span class="n">jumps</span><span class="p">,</span> <span class="k" style="color: green; font-weight: bold;">reg</span> <span class="n">calls</span><span class="p">);</span><br />        <span class="n">trace_instr_all</span> <span class="o" style="color: #666666;">=</span> <span class="n">all</span><span class="p">;</span><br />        <span class="n">trace_instr_jump</span> <span class="o" style="color: #666666;">=</span> <span class="n">jumps</span><span class="p">;</span><br />        <span class="n">trace_instr_call</span> <span class="o" style="color: #666666;">=</span> <span class="n">calls</span><span class="p">;</span><br />    <span class="k" style="color: green; font-weight: bold;">endtask</span><br /><br />    <span class="k" style="color: green; font-weight: bold;">always</span> <span class="p">@(</span><span class="k" style="color: green; font-weight: bold;">posedge</span> <span class="n">clock</span><span class="p">)</span> <span class="k" style="color: green; font-weight: bold;">begin</span><br />        <span class="k" style="color: green; font-weight: bold;">if</span> <span class="p">(</span><span class="n">ivalid</span><span class="p">)</span> <span class="k" style="color: green; font-weight: bold;">begin</span><br />            <span class="n">last_instr</span> <span class="o" style="color: #666666;">&lt;=</span> <span class="n">instr</span><span class="p">;</span><br />  <br />            <span class="k" style="color: green; font-weight: bold;">if</span> <span class="p">(</span><span class="n">trace_instr_all</span> <br />                <span class="o" style="color: #666666;">||</span> <span class="p">(</span><span class="n">trace_instr_jump</span> <span class="o" style="color: #666666;">&amp;&amp;</span> <span class="p">(</span><br />                    <span class="n">last_instr</span><span class="p">[</span><span class="mh" style="color: #666666;">6</span><span class="o" style="color: #666666;">:</span><span class="mh" style="color: #666666;">0</span><span class="p">]</span> <span class="o" style="color: #666666;">==</span> <span class="mh" style="color: #666666;">7</span><span class="mb" style="color: #666666;">'b1101111</span> <span class="o" style="color: #666666;">||</span> <span class="c1" style="color: #408080; font-style: italic;">// jal</span><br />                    <span class="n">last_instr</span><span class="p">[</span><span class="mh" style="color: #666666;">6</span><span class="o" style="color: #666666;">:</span><span class="mh" style="color: #666666;">0</span><span class="p">]</span> <span class="o" style="color: #666666;">==</span> <span class="mh" style="color: #666666;">7</span><span class="mb" style="color: #666666;">'b1100111</span><span class="p">))</span>  <span class="c1" style="color: #408080; font-style: italic;">// jalr</span><br />                <span class="o" style="color: #666666;">||</span> <span class="p">(</span><span class="n">trace_instr_call</span> <span class="o" style="color: #666666;">&amp;&amp;</span> <span class="p">(</span><br />                    <span class="c1" style="color: #408080; font-style: italic;">// JAL with a non-zero link target</span><br />                    <span class="n">last_instr</span><span class="p">[</span><span class="mh" style="color: #666666;">6</span><span class="o" style="color: #666666;">:</span><span class="mh" style="color: #666666;">0</span><span class="p">]</span> <span class="o" style="color: #666666;">==</span> <span class="mh" style="color: #666666;">7</span><span class="mb" style="color: #666666;">'b1101111</span> <span class="o" style="color: #666666;">||</span><br />                    <span class="n">last_instr</span><span class="p">[</span><span class="mh" style="color: #666666;">6</span><span class="o" style="color: #666666;">:</span><span class="mh" style="color: #666666;">0</span><span class="p">]</span> <span class="o" style="color: #666666;">==</span> <span class="mh" style="color: #666666;">7</span><span class="mb" style="color: #666666;">'b1100111</span><span class="p">)</span> <span class="o" style="color: #666666;">&amp;&amp;</span> <span class="n">last_instr</span><span class="p">[</span><span class="mh" style="color: #666666;">11</span><span class="o" style="color: #666666;">:</span><span class="mh" style="color: #666666;">7</span><span class="p">]</span> <span class="o" style="color: #666666;">!=</span> <span class="mh" style="color: #666666;">5</span><span class="mb" style="color: #666666;">'b0</span><span class="p">)</span><br />               <span class="p">)</span> <span class="k" style="color: green; font-weight: bold;">begin</span><br />                <span class="n">instr_exec</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">instr</span><span class="p">);</span><br />            <span class="k" style="color: green; font-weight: bold;">end</span><br />        <span class="k" style="color: green; font-weight: bold;">end</span><br />    <span class="k" style="color: green; font-weight: bold;">end</span><br /><br />    <span class="c1" style="color: #408080; font-style: italic;">// ...</span><br /><br /><span class="k" style="color: green; font-weight: bold;">endmodule</span></pre></div><div><br /></div><div>The more-interesting part, not surprisingly, is on the SystemVerilog side. The block that recognizes that an instruction has completed now needs to make a few more decisions before determining whether the testbench should be notified. Specifically, we check the last instruction executed to determine whether it was a jump, or whether it was a call. In the RISC-V ISA, the only difference between a jump and a call is that a jump will not specify a link register to store the return address.</div><div><br /></div><div>Even here, the code isn't too complicated. The BFM also contains code that checks memory-write addresses against a series of user-specified address regions, and only passes on writes that are within one of this regions. I'll omit this code, since you probably get the idea by now...</div><div><br /></div><div>So, what is the impact? Well, right around 2x in the FWRISC testbench! One of the example applications that comes with Zephyr is an implementation of the <a href="https://github.com/zephyrproject-rtos/zephyr/tree/master/samples/philosophers">Dining Philosophers</a> problem. It's actually a fun test to run because it doesn't just print text, it generates animations! Because this test is multi-threaded, and because it involves time delays, it can be somewhat time-consuming to run in simulation.&nbsp;</div><div><br /></div><div><div><table border="1" class="Table Border SCXO101641165 BCX0" style="-webkit-tap-highlight-color: transparent; -webkit-user-drag: none; background-color: white; border-collapse: collapse; color: black; empty-cells: show; font-family: &quot;Segoe UI&quot;, &quot;Segoe UI Web&quot;, Arial, Verdana, sans-serif; font-size: 12px; margin: 0px; min-width: 0px; overflow: visible; padding: 0px; position: relative; user-select: text;"><tbody class="SCXO101641165 BCX0" style="-webkit-tap-highlight-color: transparent; -webkit-user-drag: none; margin: 0px; padding: 0px; user-select: text;"><tr class="TableRow SCXO101641165 BCX0" role="row" style="-webkit-tap-highlight-color: transparent; -webkit-user-drag: none; height: auto; margin: 0px; overflow: visible; padding: 0px; user-select: text;"><td class="SCXO101641165 BCX0" role="rowheader" style="-webkit-tap-highlight-color: transparent; -webkit-user-drag: none; background-color: transparent; border: 1px solid rgb(200, 202, 204); margin: 0px; overflow: visible; padding: 3px 0px; user-select: text; vertical-align: top; word-break: break-word;"><div class="TableCellContent SCXO101641165 BCX0" style="-webkit-tap-highlight-color: transparent; -webkit-user-drag: none; margin: 0px; padding: 0px 4px; user-select: text;"><div class="OutlineElement Ltr  BCX0 SCXO101641165" style="-webkit-tap-highlight-color: transparent; -webkit-user-drag: none; clear: both; cursor: text; direction: ltr; margin: 0px; overflow: visible; padding: 0px; position: relative; user-select: text;"><div class="Paragraph SCXO101641165 BCX0" lang="EN-US" style="-webkit-tap-highlight-color: transparent; -webkit-user-drag: none; background-color: transparent; color: windowtext; overflow-wrap: break-word; padding: 0px; user-select: text; vertical-align: baseline;" xml:lang="EN-US"><span class="TextRun SCXO101641165 BCX0" data-contrast="auto" lang="EN-US" style="font-family: &quot;calibri&quot; , &quot;calibri_msfontservice&quot; , sans-serif; font-size: 11pt; line-height: 18px; margin: 0px; padding: 0px;" xml:lang="EN-US">Scenario</span><span class="EOP SCXO101641165 BCX0" style="font-family: &quot;calibri&quot; , &quot;calibri_msfontservice&quot; , sans-serif; font-size: 11pt; line-height: 18px; margin: 0px; padding: 0px;">&nbsp;</span></div></div></div></td><td class="SCXO101641165 BCX0" role="columnheader" style="-webkit-tap-highlight-color: transparent; -webkit-user-drag: none; background-color: transparent; border: 1px solid rgb(200, 202, 204); margin: 0px; overflow: visible; padding: 3px 0px; user-select: text; vertical-align: top; word-break: break-word;"><div class="TableCellContent SCXO101641165 BCX0" style="-webkit-tap-highlight-color: transparent; -webkit-user-drag: none; margin: 0px; padding: 0px 4px; user-select: text;"><div class="OutlineElement Ltr  BCX0 SCXO101641165" style="-webkit-tap-highlight-color: transparent; -webkit-user-drag: none; clear: both; cursor: text; direction: ltr; margin: 0px; overflow: visible; padding: 0px; position: relative; user-select: text;"><div class="Paragraph SCXO101641165 BCX0" lang="EN-US" style="-webkit-tap-highlight-color: transparent; -webkit-user-drag: none; background-color: transparent; color: windowtext; overflow-wrap: break-word; padding: 0px; user-select: text; vertical-align: baseline;" xml:lang="EN-US"><span class="TextRun SCXO101641165 BCX0" data-contrast="auto" lang="EN-US" style="font-family: &quot;calibri&quot; , &quot;calibri_msfontservice&quot; , sans-serif; font-size: 11pt; line-height: 18px; margin: 0px; padding: 0px;" xml:lang="EN-US">Time</span><span class="EOP SCXO101641165 BCX0" style="font-family: &quot;calibri&quot; , &quot;calibri_msfontservice&quot; , sans-serif; font-size: 11pt; line-height: 18px; margin: 0px; padding: 0px;">&nbsp;</span></div></div></div></td></tr><tr class="TableRow SCXO101641165 BCX0" role="row" style="-webkit-tap-highlight-color: transparent; -webkit-user-drag: none; height: auto; margin: 0px; overflow: visible; padding: 0px; user-select: text;"><td class="SCXO101641165 BCX0" role="rowheader" style="-webkit-tap-highlight-color: transparent; -webkit-user-drag: none; background-color: transparent; border: 1px solid rgb(200, 202, 204); margin: 0px; overflow: visible; padding: 3px 0px; user-select: text; vertical-align: top; word-break: break-word;"><div class="TableCellContent SCXO101641165 BCX0" style="-webkit-tap-highlight-color: transparent; -webkit-user-drag: none; margin: 0px; padding: 0px 4px; user-select: text;"><div class="OutlineElement Ltr  BCX0 SCXO101641165" style="-webkit-tap-highlight-color: transparent; -webkit-user-drag: none; clear: both; cursor: text; direction: ltr; margin: 0px; overflow: visible; padding: 0px; position: relative; user-select: text;"><div class="Paragraph SCXO101641165 BCX0" lang="EN-US" style="-webkit-tap-highlight-color: transparent; -webkit-user-drag: none; background-color: transparent; color: windowtext; overflow-wrap: break-word; padding: 0px; user-select: text; vertical-align: baseline;" xml:lang="EN-US"><span class="TextRun SCXO101641165 BCX0" data-contrast="auto" lang="EN-US" style="font-family: &quot;calibri&quot; , &quot;calibri_msfontservice&quot; , sans-serif; font-size: 11pt; line-height: 18px; margin: 0px; padding: 0px;" xml:lang="EN-US"><span class="SpellingError SCXO101641165 BCX0" style="-webkit-tap-highlight-color: transparent; -webkit-user-drag: none; background-color: inherit; background-image: url(&quot;data:image/gif; background-position: left bottom; background-repeat: repeat-x; border-bottom: 1px solid transparent; margin: 0px; padding: 0px; user-select: text;">Verilator</span><span class="NormalTextRun SCXO101641165 BCX0" style="-webkit-tap-highlight-color: transparent; -webkit-user-drag: none; background-color: inherit; margin: 0px; padding: 0px; user-select: text;">&nbsp;/ Task BFM (Full)</span></span><span class="EOP SCXO101641165 BCX0" style="font-family: &quot;calibri&quot; , &quot;calibri_msfontservice&quot; , sans-serif; font-size: 11pt; line-height: 18px; margin: 0px; padding: 0px;">&nbsp;</span></div></div></div></td><td class="SCXO101641165 BCX0" style="-webkit-tap-highlight-color: transparent; -webkit-user-drag: none; background-color: transparent; border: 1px solid rgb(200, 202, 204); margin: 0px; overflow: visible; padding: 3px 0px; user-select: text; vertical-align: top; word-break: break-word;"><div class="TableCellContent SCXO101641165 BCX0" style="-webkit-tap-highlight-color: transparent; -webkit-user-drag: none; margin: 0px; padding: 0px 4px; user-select: text;"><div class="OutlineElement Ltr  BCX0 SCXO101641165" style="-webkit-tap-highlight-color: transparent; -webkit-user-drag: none; clear: both; cursor: text; direction: ltr; margin: 0px; overflow: visible; padding: 0px; position: relative; user-select: text;"><div class="Paragraph SCXO101641165 BCX0" lang="EN-US" style="-webkit-tap-highlight-color: transparent; -webkit-user-drag: none; background-color: transparent; color: windowtext; overflow-wrap: break-word; padding: 0px; user-select: text; vertical-align: baseline;" xml:lang="EN-US"><span class="TextRun SCXO101641165 BCX0" data-contrast="auto" lang="EN-US" style="font-family: &quot;calibri&quot; , &quot;calibri_msfontservice&quot; , sans-serif; font-size: 11pt; line-height: 18px; margin: 0px; padding: 0px;" xml:lang="EN-US">1:05</span><span class="EOP SCXO101641165 BCX0" style="font-family: &quot;calibri&quot; , &quot;calibri_msfontservice&quot; , sans-serif; font-size: 11pt; line-height: 18px; margin: 0px; padding: 0px;">&nbsp;</span></div></div></div></td></tr><tr class="TableRow SCXO101641165 BCX0" role="row" style="-webkit-tap-highlight-color: transparent; -webkit-user-drag: none; height: auto; margin: 0px; overflow: visible; padding: 0px; user-select: text;"><td class="SCXO101641165 BCX0" role="rowheader" style="-webkit-tap-highlight-color: transparent; -webkit-user-drag: none; background-color: transparent; border: 1px solid rgb(200, 202, 204); margin: 0px; overflow: visible; padding: 3px 0px; user-select: text; vertical-align: top; word-break: break-word;"><div class="TableCellContent SCXO101641165 BCX0" style="-webkit-tap-highlight-color: transparent; -webkit-user-drag: none; margin: 0px; padding: 0px 4px; user-select: text;"><div class="OutlineElement Ltr  BCX0 SCXO101641165" style="-webkit-tap-highlight-color: transparent; -webkit-user-drag: none; clear: both; cursor: text; direction: ltr; margin: 0px; overflow: visible; padding: 0px; position: relative; user-select: text;"><div class="Paragraph SCXO101641165 BCX0" lang="EN-US" style="-webkit-tap-highlight-color: transparent; -webkit-user-drag: none; background-color: transparent; color: windowtext; overflow-wrap: break-word; padding: 0px; user-select: text; vertical-align: baseline;" xml:lang="EN-US"><span class="TextRun SCXO101641165 BCX0" data-contrast="auto" lang="EN-US" style="font-family: &quot;calibri&quot; , &quot;calibri_msfontservice&quot; , sans-serif; font-size: 11pt; line-height: 18px; margin: 0px; padding: 0px;" xml:lang="EN-US"><span class="SpellingError SCXO101641165 BCX0" style="-webkit-tap-highlight-color: transparent; -webkit-user-drag: none; background-color: inherit; background-image: url(&quot;data:image/gif; background-position: left bottom; background-repeat: repeat-x; border-bottom: 1px solid transparent; margin: 0px; padding: 0px; user-select: text;">Verilator</span><span class="NormalTextRun SCXO101641165 BCX0" style="-webkit-tap-highlight-color: transparent; -webkit-user-drag: none; background-color: inherit; margin: 0px; padding: 0px; user-select: text;">&nbsp;/ Task BFM (Min)</span></span><span class="EOP SCXO101641165 BCX0" style="font-family: &quot;calibri&quot; , &quot;calibri_msfontservice&quot; , sans-serif; font-size: 11pt; line-height: 18px; margin: 0px; padding: 0px;">&nbsp;</span></div></div></div></td><td class="SCXO101641165 BCX0" style="-webkit-tap-highlight-color: transparent; -webkit-user-drag: none; background-color: transparent; border: 1px solid rgb(200, 202, 204); margin: 0px; overflow: visible; padding: 3px 0px; user-select: text; vertical-align: top; word-break: break-word;"><div class="TableCellContent SCXO101641165 BCX0" style="-webkit-tap-highlight-color: transparent; -webkit-user-drag: none; margin: 0px; padding: 0px 4px; user-select: text;"><div class="OutlineElement Ltr  BCX0 SCXO101641165" style="-webkit-tap-highlight-color: transparent; -webkit-user-drag: none; clear: both; cursor: text; direction: ltr; margin: 0px; overflow: visible; padding: 0px; position: relative; user-select: text;"><div class="Paragraph SCXO101641165 BCX0" lang="EN-US" style="-webkit-tap-highlight-color: transparent; -webkit-user-drag: none; background-color: transparent; color: windowtext; overflow-wrap: break-word; padding: 0px; user-select: text; vertical-align: baseline;" xml:lang="EN-US"><span class="TextRun SCXO101641165 BCX0" data-contrast="auto" lang="EN-US" style="font-family: &quot;calibri&quot; , &quot;calibri_msfontservice&quot; , sans-serif; font-size: 11pt; line-height: 18px; margin: 0px; padding: 0px;" xml:lang="EN-US">0:24</span><span class="EOP SCXO101641165 BCX0" style="font-family: &quot;calibri&quot; , &quot;calibri_msfontservice&quot; , sans-serif; font-size: 11pt; line-height: 18px; margin: 0px; padding: 0px;">&nbsp;</span></div></div></div></td></tr></tbody></table></div><br /><div>The table above compares the time needed to run this test with the BFM issuing all events to the testbench (Full), and the time needed when only minimum events are issued (Min). It's hard to ignore an improvement of this magnitude, achieved simply by addition of a little bit of logic in the BFM to allow it to locally make more intelligent choices on whether to notify the testbench of activity.&nbsp;</div><div><br /></div><div>You can even see the difference visually in the two videos below. In both cases, the video runs to the same point in the test (same text displayed), and then the video repeats. The video on the left shows a run with the BFM forwarding all events to the testbench. This run takes about 12 seconds to get to the defined point in the test. The video on the right shows a run with the BFM only forwarding key events to the testbench. This run takes about 6 seconds to get to the defined point in the test.<br /><table><tbody><tr><td><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-Whii4opAvnA/XjuAvhO_36I/AAAAAAAAC1Q/mBtGyA5AWSEup6VBjR4kGEcm0G4qKkvBQCLcBGAsYHQ/s1600/Philosophers2_slow2.gif" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="476" data-original-width="688" height="221" src="https://1.bp.blogspot.com/-Whii4opAvnA/XjuAvhO_36I/AAAAAAAAC1Q/mBtGyA5AWSEup6VBjR4kGEcm0G4qKkvBQCLcBGAsYHQ/s320/Philosophers2_slow2.gif" width="320" /></a></div></td><td><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-pHH_6WsK3vU/XjuAzuOkPMI/AAAAAAAAC1U/t4_kMcnFcFUzcyZdjX2XukwuJUL38BVNwCLcBGAsYHQ/s1600/Philosophers2_fast2.gif" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="476" data-original-width="688" height="220" src="https://1.bp.blogspot.com/-pHH_6WsK3vU/XjuAzuOkPMI/AAAAAAAAC1U/t4_kMcnFcFUzcyZdjX2XukwuJUL38BVNwCLcBGAsYHQ/s320/Philosophers2_fast2.gif" width="320" /></a></div></td></tr><tr><td align="center">BFM (Full Activity)</td><td align="center">BFM (Selectively-Muted Activity)</td></tr></tbody></table><br /><div><br /></div><div><div><b>Conclusion</b></div><div>Enabling BFMs to make more decisions locally about when an event is truly of interest to the testbench can have a significant beneficial impact on performance. I've illustrated this technique using Python as a testbench language running in event-driven and cycle-driven simulation engines. However, this approach applies to other testbench languages (eg SystemVerilog) and other execution platforms (eg Emulators, FPGA prototypes). Next time you write a BFM (whether general-purpose or special-purpose), consider what degree of intelligence to embed in the BFM and which categories of events you may want to selectively "mute" in exchange for increased throughput.</div></div><div><br /></div><div><br /><div class="separator" style="clear: both;"><b><i>Disclaimer</i></b></div><div class="separator" style="clear: both;"><i>The views and opinions expressed above are solely those of the author and do not represent those of my employer or any other party.</i></div><div class="separator" style="clear: both;"><i><br /></i></div></div></div></div>