---
layout: legacy_post
title: Modeling Random Stimulus and Functional Coverage in Python
date: '2020-03-27T14:02:00.003-07:00'
author: Matthew Ballance
tags:
- CRAVE
- SMT
- functional coverage
- Python
- Boolector
- Cocotb
- PyVSC
- UVM
- Functional Verification
- constrained random
modified_time: '2020-05-15T09:00:46.056-07:00'
thumbnail: https://1.bp.blogspot.com/-3xDfd2VYh08/Xn5nbRvUAUI/AAAAAAAAC4M/LF-klZXXRdY45dulHRG4k1iyXbeFy1EBQCLcBGAsYHQ/s72-c/ModelingRandomStimulusSplash.png
blogger_id: tag:blogger.com,1999:blog-142675602739945566.post-4688440595080223691
blogger_orig_url: https://bitsbytesgates.blogspot.com/2020/03/modeling-random-stimulus-and-functional.html
---

<div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-3xDfd2VYh08/Xn5nbRvUAUI/AAAAAAAAC4M/LF-klZXXRdY45dulHRG4k1iyXbeFy1EBQCLcBGAsYHQ/s1600/ModelingRandomStimulusSplash.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="300" data-original-width="540" src="https://1.bp.blogspot.com/-3xDfd2VYh08/Xn5nbRvUAUI/AAAAAAAAC4M/LF-klZXXRdY45dulHRG4k1iyXbeFy1EBQCLcBGAsYHQ/s1600/ModelingRandomStimulusSplash.png" /></a></div><div style="text-align: center;"><br /></div><br />If you've been following the blog over the last year, you've probably noticed that I've spent quite a bit of time over the last year learning and using Python. For several reasons, it's become my new favorite programming language. Until recently, I've mostly used Python as an implementation language. However, I've been curious as to how well Python works for implementing an embedded domain-specific language (eDSL). Most of my experience in this space has been with C++, so I was looking for an excuse to experiment.<br /><br />In addition to using Python as a general programming language, I've also been using it as a testbench language for functional verification. I've spent time learning about the cocotb library that interfaces Python to a simulation engine, and in building an efficient task-based interface between Python and BFMs in simulation. With a decade or so developing OVM and UVM testbench environments, one thing I found myself missing in Python were the constraint and functional coverage modeling features that SystemVerilog provides. Now, to be clear, there is at least one existing Python library that provides random stimulus in Python, but after evaluating the approach and supported features against commonly-used SystemVerilog features, I decided to proceed in a different direction.<br /><br /><b>Functional Verification and Constrained Random Stimulus</b><br />Constrained-random stimulus and functional coverage have become well-ingrained in functional verification practice over the last decade or more. SystemVerilog, of course, embeds this functionality in the language, SystemC offers two libraries (SCV and CRAVE) for randomization. The Accellera Portable Test and Stimulus (PSS) language also specifies constrained-randomization and functional coverage features. These existing specifications all overlap on a few key features, though they also each have some unique features.<br /><br />From a requirements perspective, I wanted to support a super-set of the constraint and functional coverage features from these existing sources to the extent possible. In addition to wanting to support as many useful features as possible, reuse was a key consideration. We're also beginning to see some open-source UVM-based libraries, such as the <a href="https://github.com/google/riscv-dv">riscv-dv</a> project from Google for generating RISC-V instruction streams, that include constraints and functional coverage. This library and others are implemented in SystemVerilog, of course, but could be translated to Python. The porting task is definitely eased if the constraints and coverage can simply be mechanically translated instead of being reworked and remodeled to target a different set of supported constructs.<br /><br /><b>Key Requirements</b><br />After a bit of investigation, I settled on the following requirements for my library, and decided to name it Python Verification Stimulus and Coverage (PyVSC).<br /><br /><ul><li>Keep the user-visible modeling constructs as syntactically similar to SystemVerilog as possible and practical</li><li>Provide an underlying data model that can be programmatically processed to support static analysis, checking, and visualization of the user-specified constraints and coverage.</li><li>Allow users to capture simple features in natural syntax, while allowing them to programmatically build up the model for more-complex applications.&nbsp;</li><li>Be able to take advantage of the availability and high performance of existing SMT solvers&nbsp;</li></ul><div><br /></div><div><b>PyVSC Basics</b></div><div>The code below shows a simple example of capturing a class with random fields using the PyVSC library.</div><div><pre style="box-sizing: border-box; color: #404040; font-family: SFMono-Regular, Menlo, Monaco, Consolas, &quot;Liberation Mono&quot;, &quot;Courier New&quot;, Courier, monospace; font-size: 12px; line-height: 1.4; overflow: auto; padding: 12px;"><span class="nd" style="box-sizing: border-box; color: #555555; font-weight: bold;">@vsc</span><span class="o" style="box-sizing: border-box; color: #666666;">.</span><span class="n" style="box-sizing: border-box;">randobj</span><br /><span class="k" style="box-sizing: border-box; color: #007020; font-weight: bold;">class</span> <span class="nc" style="box-sizing: border-box; color: #0e84b5; font-weight: bold;">my_item_c</span><span class="p" style="box-sizing: border-box;">(</span><span class="nb" style="box-sizing: border-box; color: #007020;">object</span><span class="p" style="box-sizing: border-box;">):</span><br />    <span class="k" style="box-sizing: border-box; color: #007020; font-weight: bold;">def</span> <span class="nf" style="box-sizing: border-box; color: #06287e;">__init__</span><span class="p" style="box-sizing: border-box;">(</span><span class="bp" style="box-sizing: border-box; color: #007020;">self</span><span class="p" style="box-sizing: border-box;">):</span><br />        <span class="bp" style="box-sizing: border-box; color: #007020;">self</span><span class="o" style="box-sizing: border-box; color: #666666;">.</span><span class="n" style="box-sizing: border-box;">a</span> <span class="o" style="box-sizing: border-box; color: #666666;">=</span> <span class="n" style="box-sizing: border-box;">vsc</span><span class="o" style="box-sizing: border-box; color: #666666;">.</span><span class="n" style="box-sizing: border-box;">rand_bit_t</span><span class="p" style="box-sizing: border-box;">(</span><span class="mi" style="box-sizing: border-box; color: #208050;">8</span><span class="p" style="box-sizing: border-box;">)</span><br />        <span class="bp" style="box-sizing: border-box; color: #007020;">self</span><span class="o" style="box-sizing: border-box; color: #666666;">.</span><span class="n" style="box-sizing: border-box;">b</span> <span class="o" style="box-sizing: border-box; color: #666666;">=</span> <span class="n" style="box-sizing: border-box;">vsc</span><span class="o" style="box-sizing: border-box; color: #666666;">.</span><span class="n" style="box-sizing: border-box;">rand_bit_t</span><span class="p" style="box-sizing: border-box;">(</span><span class="mi" style="box-sizing: border-box; color: #208050;">8</span><span class="p" style="box-sizing: border-box;">)</span><br /><br />     <span class="nd" style="box-sizing: border-box; color: #555555; font-weight: bold;">@vsc</span><span class="o" style="box-sizing: border-box; color: #666666;">.</span><span class="n" style="box-sizing: border-box;">constraint</span><br />     <span class="k" style="box-sizing: border-box; color: #007020; font-weight: bold;">def</span> <span class="nf" style="box-sizing: border-box; color: #06287e;">ab_c</span><span class="p" style="box-sizing: border-box;">(</span><span class="bp" style="box-sizing: border-box; color: #007020;">self</span><span class="p" style="box-sizing: border-box;">):</span><br />         <span class="bp" style="box-sizing: border-box; color: #007020;">self</span><span class="o" style="box-sizing: border-box; color: #666666;">.</span><span class="n" style="box-sizing: border-box;">a</span> <span class="o" style="box-sizing: border-box; color: #666666;">!=</span> <span class="mi" style="box-sizing: border-box; color: #208050;">0</span><br />         <span class="bp" style="box-sizing: border-box; color: #007020;">self</span><span class="o" style="box-sizing: border-box; color: #666666;">.</span><span class="n" style="box-sizing: border-box;">a</span> <span class="o" style="box-sizing: border-box; color: #666666;">&lt;=</span> <span class="bp" style="box-sizing: border-box; color: #007020;">self</span><span class="o" style="box-sizing: border-box; color: #666666;">.</span><span class="n" style="box-sizing: border-box;">b</span><br />         <span class="bp" style="box-sizing: border-box; color: #007020;">self</span><span class="o" style="box-sizing: border-box; color: #666666;">.</span><span class="n" style="box-sizing: border-box;">b</span> <span class="ow" style="box-sizing: border-box; color: #007020; font-weight: bold;">in</span> <span class="n" style="box-sizing: border-box;">vsc</span><span class="o" style="box-sizing: border-box; color: #666666;">.</span><span class="n" style="box-sizing: border-box;">rangelist</span><span class="p" style="box-sizing: border-box;">(</span><span class="mi" style="box-sizing: border-box; color: #208050;">1</span><span class="p" style="box-sizing: border-box;">,</span><span class="mi" style="box-sizing: border-box; color: #208050;">2</span><span class="p" style="box-sizing: border-box;">,</span><span class="mi" style="box-sizing: border-box; color: #208050;">4</span><span class="p" style="box-sizing: border-box;">,</span><span class="mi" style="box-sizing: border-box; color: #208050;">8</span><span class="p" style="box-sizing: border-box;">)</span></pre></div><div>Note that the class is identified as a randomizable class via the <i>vsc.randobj</i>&nbsp;decorator. Decorators, which Python supports as a first-class construct, enable classes and methods to be tagged as having special significance. They also allow additional functionality to be layered on. In this case, functions for randomization will be added to the class. The class inheritance hierarchy will also be altered slightly, to allow constraints and random fields to be configured after construction of a class instance. However,&nbsp;</div><div><br /></div><div>Class fields (both random and non-random) that will participate in randomization are declared using VSC types. This enables information on bit-width and randomizable status to be associated with class fields.&nbsp;</div><div><br /></div><div>Now, let's have a look at functional coverage.</div><div><pre style="box-sizing: border-box; color: #404040; font-family: SFMono-Regular, Menlo, Monaco, Consolas, &quot;Liberation Mono&quot;, &quot;Courier New&quot;, Courier, monospace; font-size: 12px; line-height: 1.4; overflow: auto; padding: 12px;">  <span class="nd" style="box-sizing: border-box; color: #555555; font-weight: bold;">@vsc</span><span class="o" style="box-sizing: border-box; color: #666666;">.</span><span class="n" style="box-sizing: border-box;">covergroup</span><br />  <span class="k" style="box-sizing: border-box; color: #007020; font-weight: bold;">class</span> <span class="nc" style="box-sizing: border-box; color: #0e84b5; font-weight: bold;">my_cg</span><span class="p" style="box-sizing: border-box;">(</span><span class="nb" style="box-sizing: border-box; color: #007020;">object</span><span class="p" style="box-sizing: border-box;">):</span><br /><br />      <span class="k" style="box-sizing: border-box; color: #007020; font-weight: bold;">def</span> <span class="nf" style="box-sizing: border-box; color: #06287e;">__init__</span><span class="p" style="box-sizing: border-box;">(</span><span class="bp" style="box-sizing: border-box; color: #007020;">self</span><span class="p" style="box-sizing: border-box;">):</span><br />          <span class="c1" style="box-sizing: border-box; color: #408090; font-style: italic;"># Define the parameters accepted by the sample function</span><br />          <span class="bp" style="box-sizing: border-box; color: #007020;">self</span><span class="o" style="box-sizing: border-box; color: #666666;">.</span><span class="n" style="box-sizing: border-box;">with_sample</span><span class="p" style="box-sizing: border-box;">(</span><span class="nb" style="box-sizing: border-box; color: #007020;">dict</span><span class="p" style="box-sizing: border-box;">(</span><br />              <span class="n" style="box-sizing: border-box;">it</span><span class="o" style="box-sizing: border-box; color: #666666;">=</span><span class="n" style="box-sizing: border-box;">my_item_c</span><span class="p" style="box-sizing: border-box;">()</span><br />           <span class="p" style="box-sizing: border-box;">))</span><br /><br />           <span class="bp" style="box-sizing: border-box; color: #007020;">self</span><span class="o" style="box-sizing: border-box; color: #666666;">.</span><span class="n" style="box-sizing: border-box;">a_cp</span> <span class="o" style="box-sizing: border-box; color: #666666;">=</span> <span class="n" style="box-sizing: border-box;">vsc</span><span class="o" style="box-sizing: border-box; color: #666666;">.</span><span class="n" style="box-sizing: border-box;">coverpoint</span><span class="p" style="box-sizing: border-box;">(</span> <span class="bp" style="box-sizing: border-box; color: #007020;">self</span><span class="o" style="box-sizing: border-box; color: #666666;">.</span><span class="n" style="box-sizing: border-box;">it</span><span class="o" style="box-sizing: border-box; color: #666666;">.</span><span class="n" style="box-sizing: border-box;">a</span><span class="p" style="box-sizing: border-box;">,</span> <span class="n" style="box-sizing: border-box;">bins</span><span class="o" style="box-sizing: border-box; color: #666666;">=</span><span class="nb" style="box-sizing: border-box; color: #007020;">dict</span><span class="p" style="box-sizing: border-box;">(</span><br />              <span class="c1" style="box-sizing: border-box; color: #408090; font-style: italic;"># Create 4 bins across the space 0..255</span><br />              <span class="n" style="box-sizing: border-box;">a_bins</span> <span class="o" style="box-sizing: border-box; color: #666666;">=</span> <span class="n" style="box-sizing: border-box;">bin_array</span><span class="p" style="box-sizing: border-box;">([</span><span class="mi" style="box-sizing: border-box; color: #208050;">4</span><span class="p" style="box-sizing: border-box;">],</span> <span class="p" style="box-sizing: border-box;">[</span><span class="mi" style="box-sizing: border-box; color: #208050;">0</span><span class="p" style="box-sizing: border-box;">,</span><span class="mi" style="box-sizing: border-box; color: #208050;">255</span><span class="p" style="box-sizing: border-box;">])</span><br />           <span class="p" style="box-sizing: border-box;">)</span><br />           <span class="bp" style="box-sizing: border-box; color: #007020;">self</span><span class="o" style="box-sizing: border-box; color: #666666;">.</span><span class="n" style="box-sizing: border-box;">b_cp</span> <span class="o" style="box-sizing: border-box; color: #666666;">=</span> <span class="n" style="box-sizing: border-box;">vsc</span><span class="o" style="box-sizing: border-box; color: #666666;">.</span><span class="n" style="box-sizing: border-box;">coverpoint</span><span class="p" style="box-sizing: border-box;">(</span><span class="bp" style="box-sizing: border-box; color: #007020;">self</span><span class="o" style="box-sizing: border-box; color: #666666;">.</span><span class="n" style="box-sizing: border-box;">it</span><span class="o" style="box-sizing: border-box; color: #666666;">.</span><span class="n" style="box-sizing: border-box;">b</span><span class="p" style="box-sizing: border-box;">,</span> <span class="n" style="box-sizing: border-box;">bins</span><span class="o" style="box-sizing: border-box; color: #666666;">=</span><span class="nb" style="box-sizing: border-box; color: #007020;">dict</span><span class="p" style="box-sizing: border-box;">(</span><br />              <span class="c1" style="box-sizing: border-box; color: #408090; font-style: italic;"># Create one bin for each value (1,2,4,8)</span><br />              <span class="n" style="box-sizing: border-box;">b_bins</span> <span class="o" style="box-sizing: border-box; color: #666666;">=</span> <span class="n" style="box-sizing: border-box;">bin_array</span><span class="p" style="box-sizing: border-box;">([],</span> <span class="mi" style="box-sizing: border-box; color: #208050;">1</span><span class="p" style="box-sizing: border-box;">,</span> <span class="mi" style="box-sizing: border-box; color: #208050;">2</span><span class="p" style="box-sizing: border-box;">,</span> <span class="mi" style="box-sizing: border-box; color: #208050;">4</span><span class="p" style="box-sizing: border-box;">,</span> <span class="mi" style="box-sizing: border-box; color: #208050;">8</span><span class="p" style="box-sizing: border-box;">)</span><br />           <span class="p" style="box-sizing: border-box;">)</span><br />           <span class="bp" style="box-sizing: border-box; color: #007020;">self</span><span class="o" style="box-sizing: border-box; color: #666666;">.</span><span class="n" style="box-sizing: border-box;">ab_cross</span> <span class="o" style="box-sizing: border-box; color: #666666;">=</span> <span class="n" style="box-sizing: border-box;">vsc</span><span class="o" style="box-sizing: border-box; color: #666666;">.</span><span class="n" style="box-sizing: border-box;">cross</span><span class="p" style="box-sizing: border-box;">([</span><span class="bp" style="box-sizing: border-box; color: #007020;">self</span><span class="o" style="box-sizing: border-box; color: #666666;">.</span><span class="n" style="box-sizing: border-box;">a_cp</span><span class="p" style="box-sizing: border-box;">,</span> <span class="bp" style="box-sizing: border-box; color: #007020;">self</span><span class="o" style="box-sizing: border-box; color: #666666;">.</span><span class="n" style="box-sizing: border-box;">b_cp</span><span class="p" style="box-sizing: border-box;">])</span></pre></div><div>A covergroup is a class decorated with the <i>vsc.covergroup</i>&nbsp;decorator. As with a randomizable class, the decorator implements proper construction order, and adds methods to the target class.&nbsp;</div><div><br /></div><div>There are several ways that coverage data can be provided to a covergroup class. In the example above, coverage data will be passed as parameters to the 'sample' method. In order to do this, we must specify the sample-method parameter names and types. This is done by calling the <i>with_sample</i>&nbsp;method and passing a Python dictionary with parameter name and type.&nbsp;</div><div><br /></div><div>Coverpoints and crosses are defined using the <i>coverpoint </i>and <i>cross</i>&nbsp;methods. Coverpoint bins are declared as shown above, and support the set of value bins supported by SystemVerilog -- individual bins containing individual values and ranges of values, and bin arrays containing values partitioned across the bins.</div><div><br /></div><div>Okay, let's put it all together. The code below creates an instance of the covergroup, an instance of the randomizable class, randomizes the class, and samples the data in the covergroup.</div><div><pre style="box-sizing: border-box; color: #404040; font-family: SFMono-Regular, Menlo, Monaco, Consolas, &quot;Liberation Mono&quot;, &quot;Courier New&quot;, Courier, monospace; font-size: 12px; line-height: 1.4; overflow: auto; padding: 12px;"> <span class="c1" style="box-sizing: border-box; color: #408090; font-style: italic;"># Create an instance of the covergroup</span><br />  <span class="n" style="box-sizing: border-box;">my_cg_i</span> <span class="o" style="box-sizing: border-box; color: #666666;">=</span> <span class="n" style="box-sizing: border-box;">my_cg</span><span class="p" style="box-sizing: border-box;">()</span><br /><br />  <span class="c1" style="box-sizing: border-box; color: #408090; font-style: italic;"># Create an instance of the item class</span><br />  <span class="n" style="box-sizing: border-box;">my_item_i</span> <span class="o" style="box-sizing: border-box; color: #666666;">=</span> <span class="n" style="box-sizing: border-box;">my_item_c</span><span class="p" style="box-sizing: border-box;">()</span><br /><br />  <span class="c1" style="box-sizing: border-box; color: #408090; font-style: italic;"># Randomize and sample coverage</span><br />  <span class="k" style="box-sizing: border-box; color: #007020; font-weight: bold;">for</span> <span class="n" style="box-sizing: border-box;">i</span> <span class="ow" style="box-sizing: border-box; color: #007020; font-weight: bold;">in</span> <span class="nb" style="box-sizing: border-box; color: #007020;">range</span><span class="p" style="box-sizing: border-box;">(</span><span class="mi" style="box-sizing: border-box; color: #208050;">16</span><span class="p" style="box-sizing: border-box;">):</span><br />      <span class="n" style="box-sizing: border-box;">my_item_i</span><span class="o" style="box-sizing: border-box; color: #666666;">.</span><span class="n" style="box-sizing: border-box;">randomize</span><span class="p" style="box-sizing: border-box;">()</span><br />      <span class="n" style="box-sizing: border-box;">my_cg_i</span><span class="o" style="box-sizing: border-box; color: #666666;">.</span><span class="n" style="box-sizing: border-box;">sample</span><span class="p" style="box-sizing: border-box;">(</span><span class="n" style="box-sizing: border-box;">my_item_i</span><span class="p" style="box-sizing: border-box;">)</span><br /><br />  <span class="c1" style="box-sizing: border-box; color: #408090; font-style: italic;"># Now, randomize keeping b in the range [1,2]</span><br />  <span class="k" style="box-sizing: border-box; color: #007020; font-weight: bold;">for</span> <span class="n" style="box-sizing: border-box;">i</span> <span class="ow" style="box-sizing: border-box; color: #007020; font-weight: bold;">in</span> <span class="nb" style="box-sizing: border-box; color: #007020;">range</span><span class="p" style="box-sizing: border-box;">(</span><span class="mi" style="box-sizing: border-box; color: #208050;">16</span><span class="p" style="box-sizing: border-box;">):</span><br />      <span class="k" style="box-sizing: border-box; color: #007020; font-weight: bold;">with</span> <span class="n" style="box-sizing: border-box;">my_item_i</span><span class="o" style="box-sizing: border-box; color: #666666;">.</span><span class="n" style="box-sizing: border-box;">randomize_with</span><span class="p" style="box-sizing: border-box;">()</span> <span class="k" style="box-sizing: border-box; color: #007020; font-weight: bold;">as</span> <span class="n" style="box-sizing: border-box;">it</span><span class="p" style="box-sizing: border-box;">:</span><br />          <span class="n" style="box-sizing: border-box;">it</span><span class="o" style="box-sizing: border-box; color: #666666;">.</span><span class="n" style="box-sizing: border-box;">b</span> <span class="ow" style="box-sizing: border-box; color: #007020; font-weight: bold;">in</span> <span class="n" style="box-sizing: border-box;">vsc</span><span class="o" style="box-sizing: border-box; color: #666666;">.</span><span class="n" style="box-sizing: border-box;">rangelist</span><span class="p" style="box-sizing: border-box;">(</span><span class="mi" style="box-sizing: border-box; color: #208050;">1</span><span class="p" style="box-sizing: border-box;">,</span><span class="mi" style="box-sizing: border-box; color: #208050;">2</span><span class="p" style="box-sizing: border-box;">)</span><br />      <span class="n" style="box-sizing: border-box;">my_cg_i</span><span class="o" style="box-sizing: border-box; color: #666666;">.</span><span class="n" style="box-sizing: border-box;">sample</span><span class="p" style="box-sizing: border-box;">(</span><span class="n" style="box-sizing: border-box;">my_item_i</span><span class="p" style="box-sizing: border-box;">)</span><br /><br />  <span class="nb" style="box-sizing: border-box; color: #007020;">print</span><span class="p" style="box-sizing: border-box;">(</span><span class="s2" style="box-sizing: border-box; color: #4070a0;">"Coverage: </span><span class="si" style="box-sizing: border-box; color: #70a0d0; font-style: italic;">%f</span><span class="s2" style="box-sizing: border-box; color: #4070a0;"> \%"</span> <span class="o" style="box-sizing: border-box; color: #666666;">%</span> <span class="p" style="box-sizing: border-box;">(</span><span class="n" style="box-sizing: border-box;">my_cg_i</span><span class="o" style="box-sizing: border-box; color: #666666;">.</span><span class="n" style="box-sizing: border-box;">get_coverage</span><span class="p" style="box-sizing: border-box;">()))</span></pre></div><div><br /></div><div>The first randomization loop randomizes the class using constraints declared in the class. The second randomization loop adds an additional inline constraint.</div><br /><b>Looking Forward</b><br />Over the next couple of posts, I'll go through the stimulus-generation and functional coverage features of PyVSC in more detail. Future posts will also tackle what to we can do in terms of static analysis of constraint models, as well as what to do with functional coverage data once we've collected it. Until then, feel free to have a look at the early documentation on <a href="https://py-vsc.readthedocs.io/en/latest">readthedocs.io</a>, and have a look at the PyVSC project on <a href="https://github.com/fvutils/pyvsc">GitHub</a>.<br /><br /><br /><div class="separator" style="clear: both;"><b><i>Disclaimer</i></b></div><div class="separator" style="clear: both;"><i>The views and opinions expressed above are solely those of the author and do not represent those of my employer or any other party.</i></div>